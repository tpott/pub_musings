<html>
	<head>
		<title>qrmodem</title>
		<script src="./qrious.js"></script>
		<script src="./qr-scanner.umd.min.js"></script>
	</head>
	<body>
		<div>Simple qr code experiment</div>

		<!-- <canvas id="raw_video"></canvas> -->
		<div>Raw Input</div>
		<video id="raw_video" autoplay></video>
		<div>Received QR</div>
		<canvas id="received_qr"></canvas>
		<div>Transmit QR</div>
		<canvas id="transmit_qr"></canvas>
		<div>Event Log</div>
		<div id="event_log"></div>
		<script>

// Lets pretend we translate packets into frames and frames into packets.
// https://en.wikipedia.org/wiki/Ethernet_frame#Structure
// Preamble
// Dest MAC
// Source MAC
// Length
// Data
// Checksum

// Arbitrarily use a circle buffer
let rxi = 0;
let txi = 0;
let bufSize = 65536; // 2 ^ 16
let rxBuf = new Uint8Array(bufSize);
let txBuf = new Uint8Array(bufSize);
const emptyMessage = new Uint8Array(0);
window.crypto.getRandomValues(txBuf);

let canvasElem = document.getElementById('transmit_qr');
(function() {
	let qrCode = new QRious({
		element: canvasElem,
		size: 500, // arbitrary value
		value: emptyMessage,
	});
})()

canvasElem = document.getElementById('received_qr');
(function() {
	let qrCode = new QRious({
		element: canvasElem,
		size: 500, // arbitrary value
		value: emptyMessage,
	});
})();

let logs = document.getElementById('event_log');
let newLog = document.createElement('p');
newLog.innerText = 'Starting up';
logs.appendChild(newLog);

// Some helpful code pointers:
// https://github.com/tpott/labyrinth/blob/master/server.py
// https://github.com/tpott/pub_musings/blob/master/subtitler/utterance_server.py
// https://www.html5rocks.com/en/tutorials/getusermedia/intro/
// https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia

// TODO take a hash and use as the source ethernet MAC address
let deviceId = null;
navigator.mediaDevices.enumerateDevices()
	.then(function(devices) {
		devices.forEach(function(device) {
			if (device.kind !== "videoinput") {
				return;
			}
			if (device.label === "") {
				return;
			}
			// Pick the last deviceId
			deviceId = device.deviceId;
			newLog = document.createElement('p');
			newLog.innerText = 'Got a deviceId: ' + deviceId;
			logs.appendChild(newLog);
		});
	})
	.catch(function(err) {
		console.log(err.name + ": " + err.message);
	});

navigator.mediaDevices.getUserMedia({audio: false, video: {facingMode: 'user'}})
	.then(function(stream) {
		newLog = document.createElement('p');
		newLog.innerText = 'Successfully got a stream from getUserMedia';
		logs.appendChild(newLog);
		let rawVideo = document.getElementById('raw_video');
		rawVideo.srcObject = stream;
	})
	.catch(function(err) {
		newLog = document.createElement('p');
		newLog.innerText = 'Failed to get a stream from getUserMedia: ' + err;
		logs.appendChild(newLog);
	});

let numDetections = 0;
let numNoDetections = 0;

let rawVideo = document.getElementById('raw_video');
let qrScanner = new QrScanner(
	rawVideo,
	(result) => {
		numDetections++;

		if (numDetections <= 5) {
			newLog = document.createElement('p');
			newLog.innerText = 'decoded qr code: ' + result;
			logs.appendChild(newLog);
		}

		console.log('decoded qr code:', result);

		let canvasElem = document.getElementById('received_qr');
		(function() {
			let qrCode = new QRious({
				element: canvasElem,
				size: 500, // arbitrary value
				value: result,
			});
		})();
	},
	(err) => {
		numNoDetections++;
		console.log('decoding error', err);
	},
);
qrScanner.start();
// We can call `qrScanner.stop();`, but idk when we should do that

newLog = document.createElement('p');
newLog.innerText = 'Created the scanner';
logs.appendChild(newLog);

		</script>
	</body>
</html>
